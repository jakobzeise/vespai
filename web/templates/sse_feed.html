<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>VespAI - SSE Live Feed</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            color: #fff; 
            font-family: monospace;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        .header {
            margin-bottom: 20px;
        }
        .timestamp {
            font-size: 18px;
            margin-bottom: 10px;
            color: #0f0;
        }
        canvas {
            border: 2px solid #0f0;
            max-width: 100%;
            height: auto;
        }
        .info {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .status.connected { background: #0f0; color: #000; }
        .status.connecting { background: #ff0; color: #000; }
        .status.error { background: #f00; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è VespAI Live Feed (SSE)</h1>
            <div class="timestamp" id="timestamp">{{ timestamp }}</div>
            <div class="status connecting" id="status">Connecting...</div>
        </div>
        
        <canvas id="camera" width="640" height="360"></canvas>
        
        <div class="info">
            Frame ID: <span id="frame-id">{{ frame_id }}</span> | 
            FPS: <span id="fps">{{ fps }}</span><br>
            <span id="update-counter">Updates: 0</span> | 
            <span id="last-update">Last: Never</span> |
            <span id="connection-status">Status: Initializing</span>
        </div>
    </div>
    
    <script>
        let updateCount = 0;
        let eventSource = null;
        let canvas = document.getElementById('camera');
        let ctx = canvas.getContext('2d');
        let isConnected = false;
        
        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + className;
        }
        
        function updateConnectionStatus(message) {
            document.getElementById('connection-status').textContent = 'Status: ' + message;
        }
        
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }
        
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }
            
            updateStatus('Connecting...', 'connecting');
            updateConnectionStatus('Connecting to server...');
            
            eventSource = new EventSource('/video_sse');
            
            eventSource.onopen = function() {
                isConnected = true;
                updateStatus('üü¢ LIVE (SSE)', 'connected');
                updateConnectionStatus('Connected - Waiting for frames');
                console.log('SSE connection established');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'frame') {
                        // Create new image from base64 data
                        const img = new Image();
                        img.onload = function() {
                            // Clear canvas and draw new frame
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Update counters
                            updateCount++;
                            document.getElementById('update-counter').textContent = 'Updates: ' + updateCount;
                            document.getElementById('last-update').textContent = 'Last: ' + new Date().toLocaleTimeString();
                            updateConnectionStatus('Receiving frames ‚úì');
                            
                            // Keep status green
                            if (isConnected) {
                                updateStatus('üü¢ LIVE (SSE)', 'connected');
                            }
                        };
                        img.src = 'data:image/jpeg;base64,' + data.data;
                    }
                } catch (error) {
                    console.error('Error parsing SSE data:', error);
                    updateConnectionStatus('Data parsing error');
                }
            };
            
            eventSource.onerror = function() {
                isConnected = false;
                updateStatus('üî¥ Connection Lost', 'error');
                updateConnectionStatus('Connection error - Reconnecting...');
                console.log('SSE connection error - will auto-reconnect');
                
                // Auto-reconnect after 2 seconds
                setTimeout(() => {
                    if (!isConnected) {
                        connectSSE();
                    }
                }, 2000);
            };
        }
        
        // Start SSE connection
        connectSSE();
        
        // Update timestamp every second
        setInterval(updateTimestamp, 1000);
        updateTimestamp();
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !isConnected) {
                console.log('Page became visible - reconnecting SSE');
                connectSSE();
            }
        });
        
        // Handle window focus
        window.addEventListener('focus', function() {
            if (!isConnected) {
                console.log('Window focused - reconnecting SSE');
                connectSSE();
            }
        });
        
        // Periodic connection check (every 10 seconds)
        setInterval(function() {
            if (!isConnected) {
                console.log('Periodic check - reconnecting SSE');
                connectSSE();
            }
        }, 10000);
    </script>
</body>
</html>